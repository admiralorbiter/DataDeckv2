{% extends "base.html" %}
{% from "_components/buttons.html" import button %}
{% from "_components/forms.html" import form_field %}
{% from "_components/cards.html" import card %}

{% block title %}{{ media.title }} - Post{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ url_for('main.index') }}">Home</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{{ url_for('sessions.session_detail', session_id=media.session_id) }}">
          {{ media.session.name }}
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ media.title }}
      </li>
    </ol>
  </nav>

  <div class="row">
    <!-- Main Post Content -->
    <div class="col-lg-8">
      {% call card(title="", class="post-detail-card") %}
        <!-- Post Header -->
        <div class="post-header mb-4">
          <div class="d-flex align-items-center mb-3">
            <!-- Poster Avatar -->
            <div class="poster-avatar me-3">
              {% if poster_info.avatar %}
                <img src="{{ poster_info.avatar }}" alt="{{ poster_info.name }}"
                     class="rounded-circle" width="48" height="48">
              {% else %}
                <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center"
                     style="width: 48px; height: 48px; background-color: var(--bs-secondary-bg);">
                  <i class="fas fa-user text-muted"></i>
                </div>
              {% endif %}
            </div>

            <!-- Poster Info -->
            <div class="poster-info">
              <h6 class="mb-1">{{ poster_info.name }}</h6>
              <small class="text-muted">
                {% if poster_info.type == 'admin' %}
                  <i class="fas fa-chalkboard-teacher me-1"></i>Teacher
                {% elif poster_info.type == 'student' %}
                  <i class="fas fa-user-graduate me-1"></i>Student
                {% endif %}
                â€¢ {{ media.uploaded_at.strftime('%B %d, %Y at %I:%M %p') }}
              </small>
            </div>

            <!-- Actions (for teachers) -->
            {% if not is_student_view %}
            <div class="ms-auto">
              <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" href="{{ url_for('media.edit_media', media_id=media.id) }}">
                      <i class="fas fa-edit me-2"></i>Edit
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item text-danger" href="#"
                       onclick="if(confirm('Are you sure you want to delete this post?')) {
                         fetch('{{ url_for('media.delete_media', media_id=media.id) }}', {method: 'DELETE'})
                         .then(() => window.location.href = '{{ url_for('sessions.session_detail', session_id=media.session_id) }}');
                       }">
                      <i class="fas fa-trash me-2"></i>Delete
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Post Title -->
          <h4 class="post-title mb-3">{{ media.title }}</h4>

          {% if media.description %}
          <p class="post-description text-muted mb-3">{{ media.description }}</p>
          {% endif %}
        </div>

        <!-- Media Content -->
        <div class="post-media mb-4">
          {% if media.is_project and media.project_images %}
            <!-- Project Gallery -->
            <div id="projectCarousel" class="carousel slide" data-bs-ride="carousel">
              <div class="carousel-inner">
                {% for image_path in media.project_images %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                  <img src="{{ url_for('static', filename='uploads/' + image_path) }}"
                       class="d-block w-100 rounded" alt="Project image {{ loop.index }}">
                </div>
                {% endfor %}
              </div>

              {% if media.project_images|length > 1 %}
              <button class="carousel-control-prev" type="button" data-bs-target="#projectCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#projectCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>

              <!-- Thumbnails -->
              <div class="carousel-thumbnails mt-3">
                <div class="row g-2">
                  {% for image_path in media.project_images %}
                  <div class="col-auto">
                    <img src="{{ url_for('static', filename='uploads/' + image_path) }}"
                         class="thumbnail {% if loop.first %}active{% endif %}"
                         width="60" height="60"
                         onclick="document.querySelector('#projectCarousel .carousel-item.active').classList.remove('active');
                                  document.querySelectorAll('#projectCarousel .carousel-item')[{{ loop.index0 }}].classList.add('active');
                                  document.querySelector('.thumbnail.active').classList.remove('active');
                                  this.classList.add('active');"
                         style="object-fit: cover; cursor: pointer; border: 2px solid transparent; border-radius: 4px;"
                         onmouseover="this.style.borderColor='var(--bs-primary)'"
                         onmouseout="if(!this.classList.contains('active')) this.style.borderColor='transparent'">
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>
          {% elif media.image_file %}
            <!-- Single Image -->
            <img src="{{ url_for('static', filename='uploads/' + media.image_file) }}"
                 class="img-fluid rounded" alt="{{ media.title }}">
          {% elif media.video_file %}
            <!-- Video -->
            <video controls class="w-100 rounded">
              <source src="{{ url_for('static', filename='uploads/' + media.video_file) }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>

        <!-- Interaction Stats -->
        <div class="post-stats mb-4">
          <div class="row text-center">
            <div class="col">
              <div class="stat-item">
                <i class="fas fa-chart-line text-primary mb-1"></i>
                <div class="stat-number">{{ interaction_info.graph_likes }}</div>
                <small class="text-muted">Graph Guru</small>
              </div>
            </div>
            <div class="col">
              <div class="stat-item">
                <i class="fas fa-eye text-info mb-1"></i>
                <div class="stat-number">{{ interaction_info.eye_likes }}</div>
                <small class="text-muted">Expert Engager</small>
              </div>
            </div>
            <div class="col">
              <div class="stat-item">
                <i class="fas fa-book-open text-success mb-1"></i>
                <div class="stat-number">{{ interaction_info.read_likes }}</div>
                <small class="text-muted">Supreme Storyteller</small>
              </div>
            </div>
            <div class="col">
              <div class="stat-item">
                <i class="fas fa-comments text-warning mb-1"></i>
                <div class="stat-number">{{ interaction_info.total_comments }}</div>
                <small class="text-muted">Comments</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Tags -->
        {% if media.graph_tag or media.variable_tag %}
        <div class="post-tags mb-4">
          {% if media.graph_tag %}
          <span class="badge bg-primary me-2">
            <i class="fas fa-chart-bar me-1"></i>{{ media.graph_tag }}
          </span>
          {% endif %}
          {% if media.variable_tag %}
          <span class="badge bg-info me-2">
            <i class="fas fa-tags me-1"></i>{{ media.variable_tag }}
          </span>
          {% endif %}
          {% if media.is_graph %}
          <span class="badge bg-success me-2">
            <i class="fas fa-chart-line me-1"></i>Graph
          </span>
          {% endif %}
          {% if media.is_project %}
          <span class="badge bg-secondary me-2">
            <i class="fas fa-layer-group me-1"></i>Data Deck
          </span>
          {% endif %}
        </div>
        {% endif %}
      {% endcall %}

      <!-- Comments Section -->
      {% call card(title="Comments (" + interaction_info.total_comments|string + ")", class="comments-section") %}
        <!-- Add Comment Form -->
        <div class="add-comment-form mb-4">
          <form method="POST" action="{{ url_for('posts.add_comment', media_id=media.id) }}">
            {{ comment_form.hidden_tag() }}
            {{ comment_form.parent_id() }}

            <div class="mb-3">
              {{ form_field(comment_form.text, show_label=False) }}
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                {% if is_student_view %}
                  Commenting as: Student
                {% else %}
                  Commenting as: Teacher
                {% endif %}
              </small>
              {{ button(comment_form.submit.label.text, type="submit", variant="primary") }}
            </div>
          </form>
        </div>

        <!-- Comments List -->
        <div class="comments-list">
          {% if comments %}
            {% for comment in comments %}
              {{ render_comment(comment, is_student_view) }}
            {% endfor %}
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="fas fa-comments fa-2x mb-3"></i>
              <p>No comments yet. Be the first to share your thoughts!</p>
            </div>
          {% endif %}
        </div>
      {% endcall %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      {% call card(title="Session Info", class="session-info") %}
        <div class="mb-3">
          <strong>Session:</strong> {{ media.session.name }}
        </div>
        <div class="mb-3">
          <strong>Module:</strong> {{ media.session.module.name if media.session.module else 'N/A' }}
        </div>
        <div class="mb-3">
          <strong>Section:</strong> {{ media.session.section }}
        </div>
        <div class="mb-3">
          <strong>Created:</strong> {{ media.session.created_at.strftime('%B %d, %Y') }}
        </div>

        <hr>

        <div class="d-grid">
          {{ button("Back to Session",
                    href=url_for('sessions.session_detail', session_id=media.session_id),
                    variant="outline-primary") }}
        </div>
      {% endcall %}

      <!-- Related Media (if project) -->
      {% if media.is_project and media.project_group %}
      {% call card(title="This Data Deck", class="related-media") %}
        <p class="text-muted mb-3">This post is part of a {{ media.project_images|length }}-image Data Deck.</p>
        <div class="d-grid">
          {{ button("View Full Gallery",
                    href=url_for('media.project_gallery', project_group=media.project_group),
                    variant="outline-info") }}
        </div>
      {% endcall %}
      {% endif %}
    </div>
  </div>
</div>

<!-- Macro for rendering comments -->
{% macro render_comment(comment, is_student_view, level=0) %}
<div class="comment mb-3 {% if level > 0 %}ms-4{% endif %}" style="border-left: {% if level > 0 %}3px solid var(--bs-border-color){% endif %}; {% if level > 0 %}padding-left: 1rem{% endif %};">
  <div class="comment-header d-flex align-items-center mb-2">
    <!-- Commenter Avatar -->
    <div class="commenter-avatar me-2">
      {% if comment.is_admin and comment.admin_avatar %}
        <img src="{{ comment.admin_avatar }}" alt="{{ comment.name }}"
             class="rounded-circle" width="32" height="32">
      {% else %}
        <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center"
             style="width: 32px; height: 32px; background-color: var(--bs-secondary-bg);">
          {% if comment.is_admin %}
            <i class="fas fa-chalkboard-teacher text-primary" style="font-size: 14px;"></i>
          {% else %}
            <i class="fas fa-user-graduate text-info" style="font-size: 14px;"></i>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Commenter Info -->
    <div class="commenter-info">
      <strong class="commenter-name">{{ comment.name }}</strong>
      {% if comment.is_admin %}
        <span class="badge bg-primary ms-1" style="font-size: 0.7rem;">Teacher</span>
      {% else %}
        <span class="badge bg-info ms-1" style="font-size: 0.7rem;">Student</span>
      {% endif %}
    </div>

    <!-- Comment Time -->
    <small class="text-muted ms-auto">
      {{ comment.created_at.strftime('%B %d at %I:%M %p') }}
    </small>
  </div>

  <!-- Comment Text -->
  <div class="comment-text mb-2">
    {{ comment.text|nl2br|safe }}
  </div>

  <!-- Comment Actions -->
  <div class="comment-actions">
    {% if level < 2 %}  <!-- Limit nesting to 2 levels -->
    <button class="btn btn-link btn-sm text-muted p-0 me-2"
            onclick="showReplyForm({{ comment.id }})">
      <i class="fas fa-reply me-1"></i>Reply
    </button>
    {% endif %}
  </div>

  <!-- Reply Form (hidden by default) -->
  <div id="reply-form-{{ comment.id }}" class="reply-form mt-3" style="display: none;">
    <form method="POST" action="{{ url_for('posts.add_comment', media_id=media.id) }}">
      {{ comment_form.hidden_tag() }}
      <input type="hidden" name="parent_id" value="{{ comment.id }}">

      <div class="mb-2">
        <textarea name="text" class="form-control form-control-sm" rows="2"
                  placeholder="Write a reply..." required></textarea>
      </div>

      <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-sm btn-outline-secondary me-2"
                onclick="hideReplyForm({{ comment.id }})">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary">Reply</button>
      </div>
    </form>
  </div>

  <!-- Replies -->
  {% if comment.replies %}
    <div class="replies mt-3">
      {% for reply in comment.replies %}
        {{ render_comment(reply, is_student_view, level + 1) }}
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endmacro %}
{% endblock %}

{% block scripts %}
<script>
// Reply form functionality
function showReplyForm(commentId) {
  const form = document.getElementById(`reply-form-${commentId}`);
  form.style.display = 'block';
  form.querySelector('textarea').focus();
}

function hideReplyForm(commentId) {
  const form = document.getElementById(`reply-form-${commentId}`);
  form.style.display = 'none';
  form.querySelector('textarea').value = '';
}

// Thumbnail active state styling
document.addEventListener('DOMContentLoaded', function() {
  const activeThumbnail = document.querySelector('.thumbnail.active');
  if (activeThumbnail) {
    activeThumbnail.style.borderColor = 'var(--bs-primary)';
  }
});
</script>
{% endblock %}
